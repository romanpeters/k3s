apiVersion: apps/v1
kind: Deployment
metadata:
  name: openwebui
  namespace: general
  labels:
    app.kubernetes.io/name: openwebui
    app.kubernetes.io/instance: openwebui-prod
    app.kubernetes.io/part-of: homelab
    app.kubernetes.io/managed-by: flux
    exposure: internal
spec:
  replicas: 1
  selector:
    matchLabels:
      app: openwebui
  template:
    metadata:
      labels:
        app: openwebui
        app.kubernetes.io/name: openwebui
        app.kubernetes.io/instance: openwebui-prod
        app.kubernetes.io/part-of: homelab
        app.kubernetes.io/managed-by: flux
        exposure: internal
    spec:
      initContainers:
        - name: bootstrap-ollama-config
          image: ghcr.io/open-webui/open-webui:v0.8.3@sha256:205e9cf23b66553643b065afcdeffb7f86b35bf36e0ce643dc56946a911954b7
          command: ["python", "/bootstrap/patch_ollama_config.py"]
          volumeMounts:
            - name: data
              mountPath: /app/backend/data
            - name: bootstrap-config
              mountPath: /bootstrap
      containers:
        - name: openwebui
          image: ghcr.io/open-webui/open-webui:v0.8.3@sha256:205e9cf23b66553643b065afcdeffb7f86b35bf36e0ce643dc56946a911954b7
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: OLLAMA_BASE_URLS
              value: https://ollama.romanpeters.nl
            - name: OLLAMA_API_CONFIGS
              value: '{"0":{"enable":true,"auth_type":"none","key":""}}'
            - name: TOOL_SERVER_CONNECTIONS
              valueFrom:
                secretKeyRef:
                  name: openwebui-mcp
                  key: TOOL_SERVER_CONNECTIONS
          volumeMounts:
            - name: data
              mountPath: /app/backend/data
          readinessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 20
            periodSeconds: 10
          livenessProbe:
            httpGet:
              path: /health
              port: http
            initialDelaySeconds: 30
            periodSeconds: 20
      volumes:
        - name: data
          persistentVolumeClaim:
            claimName: openwebui-data
        - name: bootstrap-config
          configMap:
            name: openwebui-bootstrap-config
